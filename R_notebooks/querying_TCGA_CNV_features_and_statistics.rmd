---
title: "Querying TCGA Features and Expression Data"
output:
  html_document:
    df_print: paged
---

The data hosted by iAtlas is available through an API.

```{r}
# git clone the notebook repo to get this file #
source('https://github.com/CRI-iAtlas/iatlas-notebooks/raw/main/functions/notebook_functions.R')
#source('functions/notebook_functions.R')
library_setup()
library(readr)
```

Exploring the datasets and features

The iAtlas data is stored in a database that can be queried with functions from the
iatlasGraphQLClient package. We have clinical data, immune features, scores of
predictors of response to immunotherapy, and quantile normalized gene expression.

You can get more information in iAtlas on immune features, and our annotation of
immunomodulators genes. You can access more information about these datasets in iAtlas.

As a first step, letâ€™s take a look at the available datasets.

```{r}
# datasets that we have in the iAtlas database
datasets <- iatlasGraphQLClient::query_datasets()
datasets
```

Let's focus on the TCGA data.

```{r}
tcga_studies <- iatlasGraphQLClient::query_tags_with_parent_tags(parent_tags = "TCGA_Study")
tcga_studies$tag_name
```

From that list, we might be interested in a particular dataset, let's look at BRCA.


```{r}
samples <- iatlasGraphQLClient::query_tag_samples(parent_tags = "TCGA_Study",tags= c(tag_name = "BRCA"))

sampleids <- samples$sample_name

length(sampleids)

head(sampleids)
```

 To start with, let's look at the list of immunomodulator genes,
and genes by gene set name.

```{r}
immunomodulators <- iatlasGraphQLClient::query_immunomodulators()
immunomodulators
```


With that query, we see the dataset contains 1087 samples.

To query the copy number results, we need to use the query_copy_number_results function. When using that function, 
it's good to remember that the'tag_name' is what will specify the TCGA tumor type.

Beware, if the list of sampleids is too long, we may get a timeout error!

```{r}
# running this function with no parameters will return the entire table.
results <- iatlasGraphQLClient::query_copy_number_results(#entrez = 22,  #22:ABCB7 # immunomodulators$entrez[1:5], 
                                                          tag='BRCA',
                                                          feature='leukocyte_fraction')
results %>% filter(entrez == 22)
```

The results table includes:
  
  'direction' 
  'mean_normal' 
  'mean_cnv' 
  'p_value' 
  'log10_p_value' 
  't_stat' 

Let's try to confirm a result.  Take BTN3A2, which is attached to a very high T statistic through the Aneuploidy Score (AS).

```{r}
lf1 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[1:100], features = 'leukocyte_fraction',)
lf2 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[101:200], features = 'leukocyte_fraction',)
lf3 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[201:300], features = 'leukocyte_fraction',)
lf4 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[301:400], features = 'leukocyte_fraction',)
lf5 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[401:500], features = 'leukocyte_fraction',)
lf6 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[601:700], features = 'leukocyte_fraction',)
lf7 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[701:800], features = 'leukocyte_fraction',)
lf8 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[801:900], features = 'leukocyte_fraction',)
lf9 <- iatlasGraphQLClient::query_feature_values(samples = sampleids[900:length(sampleids)], features = 'leukocyte_fraction',)
lfs <- rbind(lf1,lf2,lf3,lf4,lf5,lf6,lf7,lf8,lf9)
head(lfs)
```



Let's compare these scores to gene copy numbers

```{r}
cnvs <- read_table("E:/Data/pancan/all_thresholded.by_genes_whitelisted.tsv.gz")

al_ids <- colnames(cnvs)[6:ncol(cnvs)]

pat_ids <- sapply(alids, function(a) strtrim(a,12))

df <- data.frame(sample=pat_ids, ABCB7=unlist(cnvs[cnvs$Gene == 'ABCB7',6:ncol(cnvs)]))
  
dim(df) # 10713 rows

df2 <- dplyr::inner_join(df, lfs)  # lfs 972 rows, results in 959 rows #
               
head(df2)
```


```{r}

table(df2$ABCB7)

```

```{r}

t.test(df2$feature_value[df2$ABCB7 < 0], df2$feature_value[df2$ABCB7 == 0])

```




Please see https://cri-iatlas.org and let us know if we can help!

